<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/default :: html(content=~{::body})}">
<body>
<script defer src="/js/util/profit.js"></script>
<script defer src="/js/util/myAsset.js"></script>
<script defer src="/js/util/toast.js"></script>
<div class="container">
    <div id="toastContainer"
         style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>
    <h1>ê±°ë˜ì†Œ í™ˆ</h1>
    <div>
        <p>ë³´ìœ ìì‚°</p>
        <div id="myAsset">
            <p><span>ì›</span></p>
        </div>
        <div>
            <p>
                í‰ê°€ì†ìµ:
                <span th:text="${profitResult.totalProfit > 0 ? '+' : ''} +
                    ${#numbers.formatDecimal(profitResult.totalProfit, 0, 'COMMA', 0, 'POINT')}"
                      th:attr="data-profit=${profitResult.totalProfit}"
                ></span>
            </p>
            <p>
                ìˆ˜ìµë¥ :
                <span th:text="${profitResult.overallProfitRate > 0 ? '+' : ''}+
                    ${#numbers.formatDecimal(profitResult.overallProfitRate, 0, 'COMMA', 2, 'POINT')}+'%'"
                      th:attr="data-profit=${profitResult.overallProfitRate}"
                ></span>
            </p>
        </div>
    </div>
<div class="btn-group">
    <a href="#" class="btn btn-primary active" aria-current="page">ì›í™”</a>
    <a href="/trade/favorite_coin.do" class="btn btn-primary">ê´€ì‹¬</a>
    <a href="/trade/holding_coin.do" class="btn btn-primary">ë³´ìœ </a>
</div>

    <table id="tickerTable" class="table table-hover">
        <thead class="table-dark">
        <tr>
            <th>ì½”ì¸ëª…</th>
            <th>í˜„ì¬ê°€</th>
            <th>ì „ì¼ëŒ€ë¹„</th>
            <th>ê±°ë˜ëŒ€ê¸ˆ</th>
            <th>ê´€ì‹¬ëª©ë¡</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<script>
    let coinNameMapping = {};

    async function fetchCoinNameMapping() {
        try {
            const response = await fetch('/api/proxy/upbit/market/all?is_details=true');
            if (!response.ok) throw new Error(`ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤. : ${response.status}`);
            const marketData = await response.json();
            marketData.forEach(item => {
                if (item.market.startsWith('KRW-')) {
                    const ticker = item.market.replace('KRW-', '');
                    coinNameMapping[ticker] = item.korean_name;
                }
            });
        } catch (error) {
            console.error("API ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", error);
        }
    }

    async function updateTickerTable() {
        try {
            const response = await fetch('/api/proxy/upbit/ticker/all?quote_currencies=KRW');
            if (!response.ok) throw new Error(`ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤. : ${response.status}`);
            const tickerData = await response.json();
            const tbody = document.querySelector('#tickerTable tbody');
            tbody.innerHTML = "";

            tickerData.forEach(item => {
                if (item.market.startsWith('KRW')) {
                    const ticker = item.market.replace("KRW-", "");
                    const coinName = coinNameMapping[ticker] || ticker;
                    const priceFormatted = item.trade_price.toLocaleString('en-US', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 2
                    });
                    const changeRateFormatted = (item.signed_change_rate * 100).toFixed(2);
                    const changeColor = item.signed_change_rate > 0 ? 'red' : (item.signed_change_rate < 0 ? 'blue' : 'black');

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td onclick="goToChart('${ticker}')" style="cursor: pointer;">${coinName}<br>${ticker}/KRW</td>
                        <td>${priceFormatted}</td>
                        <td style="color: ${changeColor}">${item.signed_change_rate > 0 ? '+' : ''}${changeRateFormatted}%</td>
                        <td>${(item.acc_trade_price_24h / 1000000).toLocaleString('en-US', {maximumFractionDigits: 0})}ë°±ë§Œ</td>
                        <td>
                        <button type="button" class="btn btn-dark favoriteBtn" id="favoriteBtn" data-ticker="${ticker}">âœš</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
            });

        } catch (error) {
            console.error('Error updating ticker table:', error);
            document.querySelector('#tickerTable tbody').innerHTML =
                '<tr><td colspan="4">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
        }
    }

    function goToChart(coinTicker) {
        const url = `/trade/buy.do?coin=${coinTicker}`;
        window.location.href = url;
    }

    document.addEventListener("DOMContentLoaded", async () => {
        await fetchCoinNameMapping();
        await updateTickerTable();
    });

    // ì‹¤ì‹œê°„ í‰ê°€ì†ìµ/ìì‚° ì—…ë°ì´íŠ¸ (1ì´ˆ ê°„ê²©)
    setInterval(async () => {
        try {
            const res = await fetch("/trade/api/summary");
            if (!res.ok) throw new Error("ìš”ì•½ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨");
            const data = await res.json();

            // ë³´ìœ  ìì‚°
            document.querySelector("#myAsset span").innerText = data.totalAsset.toLocaleString() + "ì›";

            // í‰ê°€ ì†ìµ
            const profitEl = document.querySelector("span[data-profit]");
            const profitVal = data.totalProfit;
            profitEl.innerText = (profitVal > 0 ? '+' : '') + profitVal.toLocaleString();
            profitEl.style.color = profitVal > 0 ? 'red' : (profitVal < 0 ? 'blue' : 'black');

            // ìˆ˜ìµë¥ 
            const rateEl = document.querySelectorAll("span[data-profit]")[1];
            const rateVal = data.overallProfitRate.toFixed(2);
            rateEl.innerText = (rateVal > 0 ? '+' : '') + rateVal + '%';
            rateEl.style.color = rateVal > 0 ? 'red' : (rateVal < 0 ? 'blue' : 'black');

        } catch (e) {
            console.error("ìš”ì•½ ë°ì´í„° ê°±ì‹  ì‹¤íŒ¨", e);
        }
    }, 10000);

    // ì¦ê²¨ì°¾ê¸° ì¶”ê°€
    document.querySelector('#tickerTable tbody').addEventListener('click',async function (e) {
        if (!e.target.matches('.favoriteBtn')) return;

        const ticker = e.target.dataset.ticker;
        const fullMarket = "KRW-" + ticker;
        const data = {
            userNo : 1,
            market: fullMarket
        };

        const URL = "/trade/favorite_action.do";
        const resp = await fetch(URL,{
            method: 'POST',
            headers:{'Content-type' : 'application/json'},
            body:JSON.stringify(data)
        });
        if (resp.status===201){
            showToast(" â­ï¸  ê´€ì‹¬ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.")
        } else if(resp.status===409){
            showToast("â—ï¸ ì´ë¯¸ ê´€ì‹¬ëª©ë¡ì— ìˆìŠµë‹ˆë‹¤.")
        }else{
            showToast("ğŸš« ê´€ì‹¬ëª©ë¡ ì¶”ê°€ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.")
        }
    })
</script>
</body>
</html>